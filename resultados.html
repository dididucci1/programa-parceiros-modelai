<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model AI - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="js/theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Modern Sidebar Styles */
        .modern-sidebar {
            width: 288px;
            background: linear-gradient(145deg, #0f766e 0%, #134e4a 100%);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }

        .modern-sidebar.collapsed {
            width: 80px;
        }

        .sidebar-expanded {
            display: flex;
        }

        .modern-sidebar.collapsed .sidebar-expanded {
            display: none;
        }

        .modern-sidebar.collapsed .sidebar-text {
            display: none;
        }

        .modern-sidebar.collapsed .sidebar-icon {
            margin-right: 0;
        }

        .sidebar-item {
            border-radius: 12px;
            margin: 4px 8px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .sidebar-item:hover::before {
            left: 100%;
        }

        .sidebar-item:hover {
            background: rgba(20, 184, 166, 0.15);
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: #005B4C;
            box-shadow: none;
            color: white !important;
        }

        .sidebar-icon {
            transition: all 0.3s ease;
        }

        .sidebar-item:hover .sidebar-icon {
            transform: scale(1.1);
        }

        /* Main content adjustment */
        .main-content {
            margin-left: 288px;
            transition: margin-left 0.3s ease;
            flex: 1;
            padding: 0;
            overflow-y: auto;
        }

        .main-content.sidebar-collapsed {
            margin-left: 80px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .content {
            padding: 30px;
        }

        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .positive {
            color: #22543d;
        }

        .negative {
            color: #c53030;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .chart-container {
            height: 400px;
            margin: 20px 0;
        }

        /* Scroll horizontal para gráficos largos */
        .chart-scroll { overflow-x: auto; }
        .chart-scroll-inner { min-width: 800px; }

        .table-responsive {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            min-width: 1200px; /* força scroll horizontal quando precisar */
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap; /* não quebrar em quase todas as colunas */
            vertical-align: middle; /* alinhar verticalmente para consistência */
        }

        /* Empresa: manter em uma linha e alinhada como as demais */
        .table td:nth-child(2) {
            white-space: nowrap;
            max-width: none;
            overflow: visible;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .table td {
            color: #4a5568;
            font-size: 14px;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pago {
            background: #f0fff4;
            color: #22543d;
        }

        .status-pendente {
            background: #fffbeb;
            color: #c05621;
        }

        .status-cancelado {
            background: #fed7d7;
            color: #c53030;
        }

        /* Responsive */
        @media (max-width: 768px) {
            /* Sidebar vira off-canvas e só aparece ao abrir */
            .modern-sidebar {
                width: 80vw;
                max-width: 320px;
                height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
                transform: translateX(-100%);
                z-index: 50; /* acima do overlay */
            }

            .modern-sidebar.mobile-open {
                transform: translateX(0);
            }

            /* Conteúdo sempre ocupa a tela inteira no mobile */
            .main-content, .main-content.sidebar-collapsed {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            /* Compactar cartões/tipografia */
            .card { padding: 16px; }
            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }

            /* Tabela mais enxuta e colunas opcionais ocultas */
            .table { min-width: 700px; }
            .table th, .table td { padding: 8px 10px; font-size: 12px; }
            .col-sm-hide { display: none; }
            .btn .btn-label { display: none; }
            .btn i { margin-right: 0 !important; }

            /* Modal mais ajustado */
            #pagamentoModal > div { width: 90vw; max-width: 90vw; padding: 16px; }

            /* Resumo + Top10 em uma coluna no mobile */
            #resumoGrid { grid-template-columns: 1fr !important; }

            /* Cabeçalho da projeção: filtro acima do título e full width */
            #projecaoHeader { flex-direction: column; align-items: flex-start; gap: 10px; }
            #filtroEmpresaProjecao { width: 100%; }
            /* Garantir scroll horizontal mais cedo no mobile */
            .chart-scroll-inner { min-width: 900px; }
        }

        /* Overlay para sidebar no mobile */
        #sidebarOverlay { display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 40; }
        #sidebarOverlay.show { display:block; }

        /* Botão de menu (3 pontos) para mobile */
        .mobile-menu-btn { display: none; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 10px; background: rgba(15,118,110,0.08); color: #0f766e; border: 1px solid #e2e8f0; }
        @media (max-width: 768px){ .mobile-menu-btn { display: inline-flex; position: absolute; right: 16px; top: 14px; } }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Modern Sidebar -->
    <div id="sidebar" class="modern-sidebar">
        <!-- Logo Section -->
        <div class="p-6 border-b border-teal-700/50 sidebar-header">
            <div class="sidebar-expanded flex items-center space-x-3">
                <img src="./images/image.png" alt="Model AI" class="object-contain" style="max-height: 40px;">
            </div>
            <button id="toggleSidebar" class="text-white hover:text-teal-200 p-2 rounded-lg transition-all" title="Fechar menu">
                <i class="fas fa-chevron-left text-lg"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4">
            <div class="space-y-2">
                <a href="index.html" class="sidebar-item flex items-center p-3 text-teal-200 hover:text-white">
                    <i class="fas fa-edit sidebar-icon mr-3 text-lg"></i>
                    <span class="font-medium sidebar-text">Registrar</span>
                </a>
                
                <a href="cenarios.html" class="sidebar-item flex items-center p-3 text-teal-200 hover:text-white">
                    <i class="fas fa-eye sidebar-icon mr-3 text-lg"></i>
                    <span class="font-medium sidebar-text">Acompanhar</span>
                </a>
                
                <a href="resultados.html" class="sidebar-item active flex items-center p-3 text-white">
                    <i class="fas fa-chart-line sidebar-icon mr-3 text-lg"></i>
                    <span class="font-medium sidebar-text">Dashboard</span>
                </a>
                <a href="usuarios.html" data-admin-only class="sidebar-item flex items-center p-3 text-teal-200 hover:text-white">
                    <i class="fas fa-users-cog sidebar-icon mr-3 text-lg"></i>
                    <span class="font-medium sidebar-text">Usuários</span>
                </a>
            </div>
        </nav>

        <!-- User Info -->
        <div class="p-5 border-t border-teal-700/50">
            <div class="user-card bg-white/10 rounded-2xl px-4 py-3 flex items-center gap-3">
                <div class="w-10 h-10 bg-teal-400 rounded-full flex items-center justify-center text-teal-900 font-bold">A</div>
                <div class="sidebar-expanded flex flex-col">
                    <div class="text-white font-medium text-sm">Admin</div>
                    <div class="text-teal-200 text-xs">admin@modelai.com</div>
                </div>
            </div>
            <div class="user-actions flex items-center justify-around mt-4">
                <button id="themeToggle" class="text-teal-200 hover:text-white relative">
                    <i class="fas fa-moon"></i>
                    <div class="tooltip-card">
                        <div class="tooltip-card-title">Dark Mode</div>
                        <div class="tooltip-card-subtitle">Clique aqui para ativar o modo escuro</div>
                    </div>
                </button>
                <button class="text-teal-200 hover:text-white relative" data-logout>
                    <i class="fas fa-power-off"></i>
                    <div class="tooltip-card">
                        <div class="tooltip-card-title">Sair</div>
                        <div class="tooltip-card-subtitle">Clique aqui pra sair da plataforma</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content">
        <div class="header">
            <button id="openSidebarMobile" class="mobile-menu-btn" title="Fechar menu">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h1>Dashboard de Comissões</h1>
            <p>Acompanhe seu desempenho e resultados financeiros</p>
        </div>

        <div class="content">
            <!-- Cards de Estatísticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total de Indicações</div>
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalIndicacoesDash">0</div>
                    <div class="stat-change positive">
                        <i class="fas fa-clipboard-list"></i>
                        Indicações cadastradas
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Vendas Fechadas</div>
                        <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                            <i class="fas fa-handshake"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="vendasFechadasDash">0</div>
                    <div class="stat-change positive">
                        <i class="fas fa-check-circle"></i>
                        Negócios fechados
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Taxa de Conversão</div>
                        <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="taxaConversaoDash">0%</div>
                    <div class="stat-change positive">
                        <i class="fas fa-chart-line"></i>
                        Taxa de fechamento
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Comissão Prevista</div>
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="comissaoTotalDash">R$ 0,00</div>
                    <div class="stat-change positive">
                        <i class="fas fa-money-bill-wave"></i>
                        Receita gerada
                    </div>
                </div>
            </div>

            <!-- Tabela de Comissões Recentes -->
            <div class="card">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    💰 Comissões Recentes
                </h3>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Empresa</th>
                                <th class="col-sm-hide">Serviço</th>
                                <th>Valor Mensal</th>
                                <th>Meses</th>
                                <th>Status</th>
                                <th class="col-sm-hide">Data Fechamento</th>
                                <th data-admin-only>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaComissoes">
                            <!-- Dados serão carregados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Resumo Mensal -->
            <div id="resumoGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div class="card">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        📊 Resumo do Mês
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <span>Indicações Registradas</span>
                            <strong style="color: #3b82f6;" id="resumoIndicacoes">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <span>Vendas Fechadas</span>
                            <strong style="color: #22c55e;" id="resumoFechadas">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <span>Comissão Prevista</span>
                            <strong style="color: #22543d;" id="resumoComissoesTotais">R$ 0,00</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                            <span>Em Andamento</span>
                            <strong style="color: #f59e0b;" id="resumoAndamento">0</strong>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        🏆 Top 10 Maiores Comissões
                    </h3>
                    <div id="maioresComissoesChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Gráfico de Projeção de Recebimentos -->
            <div class="card">
                <div id="projecaoHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 12px;">
                    <select id="filtroEmpresaProjecao" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; color: #4a5568; font-size: 14px; min-width: 200px;">
                        <option value="">Todos os parceiros</option>
                    </select>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin: 0;">
                            📈 Projeção de Recebimento de Comissões
                        </h3>
                        <button id="btnExportarPDF" class="btn btn-secondary" onclick="gerarRelatorioPDF()" title="Gerar relatório em PDF" style="padding:8px 12px; border:1px solid #ef4444; border-radius:8px; background:#ef4444; color:#ffffff; display:flex; align-items:center; gap:6px; box-shadow: 0 2px 6px rgba(239,68,68,0.35);">
                            <i class="fas fa-file-pdf"></i>
                            <span class="btn-label">Exportar PDF</span>
                        </button>
                    </div>
                </div>
                <div class="chart-scroll">
                    <div class="chart-scroll-inner">
                        <div id="projecaoComissoesChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Pagamento -->
    <div id="pagamentoModal" style="display:none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 20px; width: 100%; max-width: 420px; border: 1px solid #e2e8f0;">
            <h3 style="margin: 0 0 12px 0;">Registrar pagamento</h3>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom: 16px;">
                <label for="dataPagamento" style="width: 110px;">Data pag.: </label>
                <input id="dataPagamento" type="date" style="flex:1; padding: 8px 10px; border:1px solid #e2e8f0; border-radius: 8px;" />
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="fecharModalPagamento()" class="btn btn-secondary">Cancelar</button>
                <button onclick="salvarPagamento()" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/theme.js"></script>
    <script>
        const API = window.API_BASE || '/api';
        // Cache de indicações para reduzir requisições e acelerar o carregamento
        let INDICACOES_CACHE = null;
        let INDICACOES_CACHE_AT = 0;
        async function getIndicacoes(force = false){
            const now = Date.now();
            const TTL_MS = 15000; // 15s de validade do cache
            if(!force && INDICACOES_CACHE && (now - INDICACOES_CACHE_AT) < TTL_MS){
                return INDICACOES_CACHE;
            }
            const user = (window.Auth && Auth.getCurrentUser && Auth.getCurrentUser()) || { role:'admin' };
            const isAdmin = (window.Auth && Auth.isAdmin && Auth.isAdmin());
            const query = isAdmin ? '' : `?userEmail=${encodeURIComponent(user.email||'')}`;
            const res = await fetch(`${API}/indicacoes${query}`);
            const indicacoes = await res.json();
            INDICACOES_CACHE = indicacoes || [];
            INDICACOES_CACHE_AT = Date.now();
            return INDICACOES_CACHE;
        }
        function invalidateIndicacoes(){ INDICACOES_CACHE = null; INDICACOES_CACHE_AT = 0; }
        // Sidebar toggle functionality (desktop collapse, mobile off-canvas)
        function ensureSidebarOverlay(){
            let ov = document.getElementById('sidebarOverlay');
            if(!ov){
                ov = document.createElement('div');
                ov.id = 'sidebarOverlay';
                document.body.appendChild(ov);
                ov.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.remove('mobile-open');
                    ov.classList.remove('show');
                });
            }
            return ov;
        }

        document.getElementById('toggleSidebar').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            if (window.innerWidth <= 768) {
                const ov = ensureSidebarOverlay();
                const opened = sidebar.classList.toggle('mobile-open');
                ov.classList.toggle('show', opened);
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
            }
        });

        // Mobile header button (three dots) to open menu
        const mobileOpenBtn = document.getElementById('openSidebarMobile');
        if (mobileOpenBtn) {
            mobileOpenBtn.addEventListener('click', function(){
                const sidebar = document.getElementById('sidebar');
                const ov = ensureSidebarOverlay();
                const opened = sidebar.classList.toggle('mobile-open');
                ov.classList.toggle('show', opened);
            });
        }

        // Fechar off-canvas ao redimensionar para desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                const ov = document.getElementById('sidebarOverlay');
                if (sidebar) sidebar.classList.remove('mobile-open');
                if (ov) ov.classList.remove('show');
            }
        });

        // Carregar gráfico de maiores comissões quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            carregarGraficoMaioresComissoes();
            carregarEstatisticasDashboard();
            carregarTabelaComissoes();
            carregarResumoMensal();
            carregarGraficoProjecaoComissoes();
            configurarFiltroProjecao();
            // Fechar modal clicando fora
            window.addEventListener('click', function(ev){
                const modal = document.getElementById('pagamentoModal');
                if(modal && ev.target === modal){ fecharModalPagamento(); }
            });
        });

        // Configurar filtro de empresas para projeção
        async function configurarFiltroProjecao() {
            const indicacoes = await getIndicacoes();
            const parceiros = [...new Set(indicacoes
                .filter(i => i.status === 'Fechado' && i.valorComissao && i.prazoComissao)
                .map(i => (i.usuarioNome || i.usuarioEmail))
            )].sort();

            const filtro = document.getElementById('filtroEmpresaProjecao');
            
            // Limpar opções existentes (exceto "Todas as empresas")
            filtro.innerHTML = '<option value="">Todos os parceiros</option>';
            
            // Adicionar empresas ao filtro
            parceiros.forEach(parceiro => {
                const option = document.createElement('option');
                option.value = parceiro;
                option.textContent = parceiro;
                filtro.appendChild(option);
            });

            // Adicionar evento de mudança
            filtro.addEventListener('change', function() {
                carregarGraficoProjecaoComissoes(this.value);
            });
        }

        // Função para obter o nome do serviço
        function getServicoNome(valor) {
            const servicos = {
                'controladoria': 'Controladoria',
                'viabilidade': 'Estudos de Viabilidade',
                'investidores': 'Apoio a Investidores',
                'estruturacao': 'Estruturação Financeira'
            };
            return servicos[valor] || valor;
        }

        // Carregar estatísticas do dashboard
        async function carregarEstatisticasDashboard() {
            const indicacoes = await getIndicacoes();
            
            const total = indicacoes.length;
            const fechadas = indicacoes.filter(i => i.status === 'Fechado').length;
            const taxaConversao = total > 0 ? ((fechadas / total) * 100).toFixed(1) : 0;
            const comissaoTotal = indicacoes
                .filter(i => i.status === 'Fechado' && i.valorComissao && i.prazoComissao)
                .reduce((sum, i) => sum + (parseFloat(i.valorComissao) * parseInt(i.prazoComissao)), 0);

            document.getElementById('totalIndicacoesDash').textContent = total;
            document.getElementById('vendasFechadasDash').textContent = fechadas;
            document.getElementById('taxaConversaoDash').textContent = `${taxaConversao}%`;
            document.getElementById('comissaoTotalDash').textContent = `R$ ${comissaoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Modal para registrar pagamento
        let pagandoId = null;
        function abrirModalPagamento(id){
            pagandoId = id;
            const modal = document.getElementById('pagamentoModal');
            document.getElementById('dataPagamento').valueAsDate = new Date();
            modal.style.display = 'flex';
        }
        function fecharModalPagamento(){
            pagandoId = null;
            document.getElementById('pagamentoModal').style.display = 'none';
        }

        async function salvarPagamento(){
            if(!pagandoId) return;
            const data = document.getElementById('dataPagamento').value;
            if(!data){ alert('Selecione a data do pagamento.'); return; }
            // Buscar a indicação atual para validar quantidade
            const todos = await getIndicacoes(true);
            const ind = todos.find(i => i._id === pagandoId);
            if(!ind){ alert('Indicação não encontrada.'); return; }
            const pagos = (ind.pagamentos || []).length;
            const total = parseInt(ind.prazoComissao||0);
            if(total && pagos >= total){ alert('Todos os meses já foram registrados como pagos.'); return; }
            const novos = [...(ind.pagamentos||[]), data];
            await fetch(`${API}/indicacoes/${pagandoId}`, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ pagamentos: novos }) });
            invalidateIndicacoes();
            fecharModalPagamento();
            carregarTabelaComissoes();
            carregarGraficoProjecaoComissoes(document.getElementById('filtroEmpresaProjecao').value||'');
        }

        // Desfazer o último pagamento (admin)
        async function desfazerUltimoPagamento(id){
            if(!id) return;
            const confirmar = confirm('Remover o último pagamento registrado?');
            if(!confirmar) return;
            const todos = await getIndicacoes(true);
            const ind = todos.find(i => i._id === id);
            if(!ind){ alert('Indicação não encontrada.'); return; }
            const pagamentos = [...(ind.pagamentos||[])];
            if(pagamentos.length === 0){ alert('Não há pagamentos para desfazer.'); return; }
            pagamentos.pop();
            await fetch(`${API}/indicacoes/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ pagamentos }) });
            invalidateIndicacoes();
            carregarTabelaComissoes();
            carregarGraficoProjecaoComissoes(document.getElementById('filtroEmpresaProjecao').value||'');
        }

        // Carregar tabela de comissões
        async function carregarTabelaComissoes() {
            const isAdmin = (window.Auth && Auth.isAdmin && Auth.isAdmin());
            const indicacoes = await getIndicacoes();
            const indicacoesFechadas = indicacoes
                .filter(i => i.status === 'Fechado' && i.valorComissao)
                .sort((a, b) => new Date(b.dataRegistro.split('/').reverse().join('-')) - new Date(a.dataRegistro.split('/').reverse().join('-')))
                .slice(0, 10); // Últimas 10

            const tbody = document.getElementById('tabelaComissoes');

            if (indicacoesFechadas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #718096;">
                            <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Nenhuma comissão encontrada.<br>
                            <small>Feche algumas indicações para ver as comissões aqui.</small>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = indicacoesFechadas.map(indicacao => `
                    <tr>
                        <td>${indicacao.contatoNome}</td>
                        <td>${indicacao.incorporadora}</td>
                        <td class="col-sm-hide">${getServicoNome(indicacao.servicoInteresse)}</td>
                        <td style="font-weight: 700; color: #22543d;">R$ ${parseFloat(indicacao.valorComissao).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${(indicacao.pagamentos ? indicacao.pagamentos.length : 0)}${indicacao.prazoComissao?`/${parseInt(indicacao.prazoComissao)}`:''}</td>
                          <td><span class="status-badge status-pago">Fechado</span></td>
                          <td class="col-sm-hide">${indicacao.dataRegistro}</td>
                          ${isAdmin ? `<td>${indicacao.prazoComissao ? `
                                <button class=\"btn btn-secondary\" title=\"Registrar pagamento\" onclick=\"abrirModalPagamento('${indicacao._id}')\"><i class='fas fa-receipt'></i> <span class=\"btn-label\">Registrar</span></button>
                                ${(indicacao.pagamentos && indicacao.pagamentos.length) ? ` <button class=\"btn btn-secondary\" title=\"Desfazer último pagamento\" onclick=\"desfazerUltimoPagamento('${indicacao._id}')\"><i class='fas fa-undo'></i> <span class=\"btn-label\">Desfazer</span></button>` : ''}
                            ` : ''}</td>` : ''}
                    </tr>
                `).join('');
            }
        }

        // Carregar resumo mensal
        async function carregarResumoMensal() {
            const indicacoes = await getIndicacoes();
            
            const total = indicacoes.length;
            const fechadas = indicacoes.filter(i => i.status === 'Fechado').length;
            const andamento = indicacoes.filter(i => ['Em Análise','Em Andamento','Reunião Agendada','Reunião Realizada'].includes(i.status)).length;
            const comissaoTotal = indicacoes
                .filter(i => i.status === 'Fechado' && i.valorComissao && i.prazoComissao)
                .reduce((sum, i) => sum + (parseFloat(i.valorComissao) * parseInt(i.prazoComissao)), 0);

            document.getElementById('resumoIndicacoes').textContent = total;
            document.getElementById('resumoFechadas').textContent = fechadas;
            document.getElementById('resumoAndamento').textContent = andamento;
            document.getElementById('resumoComissoesTotais').textContent = `R$ ${comissaoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        async function carregarGraficoMaioresComissoes() {
            // Buscar indicações fechadas com comissão do backend (cache)
            const indicacoes = await getIndicacoes();
            const indicacoesFechadas = indicacoes
                .filter(i => i.status === 'Fechado' && i.valorComissao && i.prazoComissao && i.valorComissao > 0)
                .map(i => ({
                    ...i,
                    valorTotal: parseFloat(i.valorComissao) * parseInt(i.prazoComissao)
                }))
                .sort((a, b) => b.valorTotal - a.valorTotal)
                .slice(0, 10); // Top 10

            if (indicacoesFechadas.length === 0) {
                // Se não houver dados, mostrar mensagem
                document.getElementById('maioresComissoesChart').innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #718096;">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <h4 style="margin: 0 0 10px 0; font-size: 16px;">Nenhuma comissão registrada</h4>
                        <p style="margin: 0; font-size: 14px; text-align: center;">
                            Feche algumas indicações na aba "Acompanhar"<br>
                            para ver o ranking de maiores comissões aqui.
                        </p>
                    </div>
                `;
            } else {
                // Usar dados reais do localStorage
                const data = [{
                    type: 'bar',
                    x: indicacoesFechadas.map(i => i.valorTotal),
                    y: indicacoesFechadas.map(i => i.incorporadora),
                    orientation: 'h',
                    marker: {
                        color: indicacoesFechadas.map((_, index) => {
                            const colors = ['#22c55e', '#16a34a', '#15803d', '#166534', '#14532d', '#065f46', '#047857', '#059669', '#10b981', '#34d399'];
                            return colors[index] || '#22c55e';
                        }),
                        line: {
                            color: 'rgba(255,255,255,0.2)',
                            width: 1
                        }
                    },
                    text: indicacoesFechadas.map(i => `R$ ${i.valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`),
                    textposition: 'outside',
                    textangle: 0,
                    cliponaxis: false,
                    textfont: {
                        color: '#1a202c',
                        weight: 'bold'
                    }
                }];

                const layout = {
                    title: {
                        text: '',
                        font: { size: 14, color: '#718096' }
                    },
                    xaxis: {
                        title: '',
                        showgrid: true,
                        gridcolor: '#f1f5f9',
                        showticklabels: false
                    },
                    yaxis: {
                        title: '',
                        automargin: true
                    },
                    margin: { l: 120, r: 140, t: 50, b: 50 },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, Roboto, sans-serif' }
                };

                Plotly.newPlot('maioresComissoesChart', data, layout, {responsive: true, displayModeBar: false});
            }
        }

        // Função para carregar gráfico de projeção de comissões
        async function carregarGraficoProjecaoComissoes(empresaFiltro = '') {
            const indicacoes = await getIndicacoes();
            let indicacoesFechadas = indicacoes.filter(i => 
                i.status === 'Fechado' && 
                i.valorComissao && 
                i.prazoComissao && 
                i.valorComissao > 0 && 
                i.prazoComissao > 0
            );

            // Aplicar filtro por parceiro se especificado
            if (empresaFiltro) {
                indicacoesFechadas = indicacoesFechadas.filter(i => (i.usuarioNome || i.usuarioEmail) === empresaFiltro);
            }

            if (indicacoesFechadas.length === 0) {
                // Se não houver dados, mostrar mensagem
                const mensagem = empresaFiltro ? 
                    `Nenhuma projeção para "${empresaFiltro}"` : 
                    'Nenhuma projeção disponível';
                
                document.getElementById('projecaoComissoesChart').innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #718096;">
                        <i class="fas fa-calendar-alt" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <h4 style="margin: 0 0 10px 0; font-size: 16px;">${mensagem}</h4>
                        <p style="margin: 0; font-size: 14px; text-align: center;">
                            ${empresaFiltro ? 
                                'Selecione "Todos os parceiros" ou outro parceiro<br>para ver outras projeções.' :
                                'Feche indicações com valor e prazo de comissão<br>para ver a projeção de recebimentos aqui.'
                            }
                        </p>
                    </div>
                `;
                return;
            }

            // Calcular projeções mensais
            const projecoes = {};
            const hoje = new Date();
            
            indicacoesFechadas.forEach(indicacao => {
                const valorMensal = parseFloat(indicacao.valorComissao); // Valor mensal que o parceiro receberá
                const pagos = (indicacao.pagamentos || []).length;
                const total = parseInt(indicacao.prazoComissao);
                const restantes = Math.max(0, total - (pagos||0));
                for (let offset = 1; offset <= restantes; offset++) {
                    const dataRecebimento = new Date(hoje.getFullYear(), hoje.getMonth() + offset, 1);
                    const chaveData = `${dataRecebimento.getFullYear()}-${String(dataRecebimento.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!projecoes[chaveData]) {
                        projecoes[chaveData] = {
                            total: 0,
                            detalhes: []
                        };
                    }
                    
                    projecoes[chaveData].total += valorMensal;
                    projecoes[chaveData].detalhes.push({
                        parceiro: (indicacao.usuarioNome || indicacao.usuarioEmail),
                        valor: valorMensal,
                        mes: pagos + offset,
                        totalMeses: total
                    });
                }
            });

            // Ordenar datas e preparar dados para o gráfico
            const datasOrdenadas = Object.keys(projecoes).sort();
            const valores = datasOrdenadas.map(data => projecoes[data].total);
            const labels = datasOrdenadas.map(data => {
                const [ano, mes] = data.split('-');
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });

            // Criar tooltips detalhados
            const tooltips = datasOrdenadas.map(data => {
                const detalhes = projecoes[data].detalhes;
                const resumo = detalhes.map(d => 
                    `${d.parceiro}: R$ ${d.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${d.mes}/${d.totalMeses})`
                ).join('<br>');
                return `<b>Total: R$ ${projecoes[data].total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</b><br>${resumo}`;
            });

            const data = [{
                type: 'bar',
                x: labels,
                y: valores,
                marker: {
                    color: valores.map((_, index) => {
                        const colors = ['#22c55e', '#16a34a', '#15803d', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
                        return colors[index % colors.length];
                    }),
                    line: {
                        color: 'rgba(255,255,255,0.2)',
                        width: 1
                    }
                },
                text: valores.map(v => `R$ ${v.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`),
                textposition: 'inside',
                textangle: 0,
                insidetextanchor: 'middle',
                textfont: {
                    size: 12,
                    color: '#ffffff'
                },
                hovertemplate: tooltips.map(tooltip => tooltip + '<extra></extra>'),
                name: 'Comissões Projetadas'
            }];

            const layout = {
                title: {
                    text: '',
                    font: { size: 16, color: '#1a202c' }
                },
                xaxis: {
                    title: '',
                    showgrid: true,
                    gridcolor: '#f1f5f9'
                },
                yaxis: {
                    visible: false,
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false
                },
                margin: { l: 80, r: 80, t: 60, b: 100 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Segoe UI, Roboto, sans-serif' },
                showlegend: false
            };

            Plotly.newPlot('projecaoComissoesChart', data, layout, {responsive: true, displayModeBar: false});
        }

        // Utilitário: carregar scripts sob demanda para não impactar performance inicial
        const __loadedScripts = new Set();
        function loadScriptOnce(src){
            return new Promise((resolve, reject) => {
                if(__loadedScripts.has(src)) return resolve();
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.onload = () => { __loadedScripts.add(src); resolve(); };
                s.onerror = () => reject(new Error('Falha ao carregar: '+src));
                document.head.appendChild(s);
            });
        }

        // Exportar relatório em PDF (visão geral + detalhado por parceiro), carregando libs apenas no clique
        async function gerarRelatorioPDF(){
            try{
                const btn = document.getElementById('btnExportarPDF');
                if(btn){ btn.disabled = true; btn.style.opacity = '0.8'; btn.querySelector('.btn-label').textContent = 'Gerando…'; }

                // Lazy-load jsPDF UMD e autotable
                await loadScriptOnce('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
                await loadScriptOnce('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js');
                const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
                if(!jsPDF || !(new jsPDF()).autoTable){
                    alert('Biblioteca de PDF não carregada. Tente novamente.');
                    if(btn){ btn.disabled = false; btn.style.opacity = '1'; btn.querySelector('.btn-label').textContent = 'Exportar PDF'; }
                    return;
                }

                // Dados: reaproveitar cache se existir
                let indicacoes = [];
                if(typeof getIndicacoes === 'function'){ indicacoes = await getIndicacoes(); }
                else {
                    const user = (window.Auth && Auth.getCurrentUser && Auth.getCurrentUser()) || { role:'admin' };
                    const isAdmin = (window.Auth && Auth.isAdmin && Auth.isAdmin());
                    const query = isAdmin ? '' : `?userEmail=${encodeURIComponent(user.email||'')}`;
                    const res = await fetch(`${API}/indicacoes${query}`);
                    indicacoes = await res.json();
                }

                const empresaFiltro = document.getElementById('filtroEmpresaProjecao').value || '';
                let fechadas = indicacoes.filter(i => i.status==='Fechado' && i.valorComissao && i.prazoComissao && i.valorComissao>0 && i.prazoComissao>0);
                if(empresaFiltro){ fechadas = fechadas.filter(i => (i.usuarioNome||i.usuarioEmail)===empresaFiltro); }
                if(fechadas.length===0){ alert('Não há dados para gerar o relatório.'); if(btn){ btn.disabled=false; btn.style.opacity='1'; btn.querySelector('.btn-label').textContent='Exportar PDF'; } return; }

                const hoje = new Date();
                const projecoes = {}; // chave AAAA-MM -> total
                // parceiro -> { nome: string, clientes: Map(cliente -> {mesKey: valor}), meses: {mesKey: valor} }
                const porParceiro = new Map();
                fechadas.forEach(i => {
                    const parceiro = (i.usuarioNome||i.usuarioEmail);
                    const valorMensal = parseFloat(i.valorComissao);
                    const pagos = (i.pagamentos||[]).length;
                    const total = parseInt(i.prazoComissao);
                    const restantes = Math.max(0, total - (pagos||0));
                    const cliente = String(i.incorporadora||i.contatoNome||'');
                    if(!porParceiro.has(parceiro)) porParceiro.set(parceiro, { nome: (i.usuarioNome||''), clientes: new Map(), meses: {} });
                    const infoP = porParceiro.get(parceiro);
                    if(!infoP.clientes.has(cliente)) infoP.clientes.set(cliente, {});
                    const mesesCliente = infoP.clientes.get(cliente);
                    for(let k=1;k<=restantes;k++){
                        const d = new Date(hoje.getFullYear(), hoje.getMonth()+k, 1);
                        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                        projecoes[key] = (projecoes[key]||0) + valorMensal;
                        infoP.meses[key] = (infoP.meses[key]||0) + valorMensal;
                        mesesCliente[key] = (mesesCliente[key]||0) + valorMensal;
                    }
                });

                const keys = Object.keys(projecoes).sort();
                const rotulos = keys.map(k=>{ const [ano,mes]=k.split('-'); const nomes=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; return `${nomes[parseInt(mes)-1]}/${ano}`; });

                const doc = new jsPDF({ unit:'pt', format:'a4' });
                doc.setFontSize(16); doc.text('Relatório de Projeção de Comissões', 40, 40);
                doc.setFontSize(10); doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 40, 58);
                if(empresaFiltro){ doc.text(`Parceiro selecionado: ${empresaFiltro}`, 40, 72); }

                // Visão geral (cores diferenciadas)
                const headOverview = ['Mês'].concat(rotulos);
                const rowOverview = ['Total'].concat(keys.map(k=>`R$ ${projecoes[k].toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}`));
                doc.autoTable({
                    head:[headOverview],
                    body:[rowOverview],
                    startY: 92,
                    styles:{ fontSize:9 },
                    headStyles:{ fillColor:[37,99,235], textColor:255 }
                });

                let y = doc.lastAutoTable.finalY + 26; // mais espaço após visão geral
                doc.setFontSize(12); doc.text('Detalhado por Parceiro', 40, y); y += 16;
                const parceirosOrdenados = Array.from(porParceiro.keys()).sort();
                for(const parceiroKey of parceirosOrdenados){
                    const info = porParceiro.get(parceiroKey);
                    const clientesMap = info.clientes; // Map(cliente -> meses)
                    const clientes = Array.from(clientesMap.keys()).filter(Boolean);
                    const nomeParceiro = info.nome || parceiroKey;
                    doc.setFontSize(11); doc.text(`Parceiro: ${nomeParceiro}`, 40, y); y += 14;
                    doc.setFontSize(9);
                    if(clientes.length){ doc.text(`Clientes fechados: ${clientes.join(', ')}`, 40, y); y += 8; }

                    // Cabeçalho: Cliente + meses
                    const head = ['Cliente'].concat(rotulos);
                    const bodyRows = [];
                    if(clientes.length >= 2){
                        // Uma linha por cliente (>=2), depois linha Total
                        for(const cliente of clientes){
                            const meses = clientesMap.get(cliente) || {};
                            const row = [cliente].concat(keys.map(k=>{ const v=(meses[k]||0); return v?`R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}`:''; }));
                            bodyRows.push(row);
                        }
                        const totalRow = ['Total'].concat(keys.map(k=>{ const v=(info.meses[k]||0); return v?`R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}`:''; }));
                        bodyRows.push(totalRow);
                    } else {
                        // Só uma linha agregada
                        const row = ['Valores'].concat(keys.map(k=>{ const v=(info.meses[k]||0); return v?`R$ ${v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}`:''; }));
                        bodyRows.push(row);
                    }

                    doc.autoTable({
                        head:[head],
                        body: bodyRows,
                        startY: y+6,
                        styles:{ fontSize:8 },
                        headStyles:{ fillColor:[13,148,136], textColor:255 }
                    });
                    y = doc.lastAutoTable.finalY + 24; // mais espaço entre parceiros
                    if(y > doc.internal.pageSize.getHeight()-80){ doc.addPage(); y = 40; }
                }

                doc.save('projecao-comissoes.pdf');
                if(btn){ btn.disabled=false; btn.style.opacity='1'; btn.querySelector('.btn-label').textContent='Exportar PDF'; }
            }catch(err){ console.error(err); alert('Não foi possível gerar o PDF.'); const btn=document.getElementById('btnExportarPDF'); if(btn){ btn.disabled=false; btn.style.opacity='1'; btn.querySelector('.btn-label').textContent='Exportar PDF'; } }
        }
    </script>
    <script src="js/auth.js"></script>
    <script src="js/setup-overlay.js"></script>
</body>
</html>
